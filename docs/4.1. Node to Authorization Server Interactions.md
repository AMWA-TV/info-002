# Node to Authorization Server Interactions  
_(c) AMWA 2021, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_
## Overview
This section details the interactions between an NMOS Node and the Authorization Server. These include:

- **Discovery of the Authorization Server**
- **Client Registration**: Registration of the NMOS Node with the Authorization Server.
- **Client Credentials Flow**: Request of an Access Token from the Authorization Server.
- **Refreshing the Bearer Token**: Ensuring the token is always valid 
- **Fetch Authorization Server Public Keys**: To authenticate Access Tokens in incoming API calls.

![Node to Authorization Interactions](../docs/images/client_credentials_flow.png)

The sequence diagram above gives an overview of these interaction which are described in more detail below.
## Discovery of the Authorization Server
In order to interact with the Authorization Server, you need to know where it is.  IS-10 specifies that the [Authorization Server should use unicast DNS-SD](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#dns-sd-advertisemen) to advertise itself to the  Node.

Once the node knows the whereabouts of the Authorization Server it can then fetch the [Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

Example request to get server metadata:

```http
GET /.well-known/oauth-authorization-server HTTP/1.1
Host: authorization-server.example.com
```
Example server metadata HTTP response:
```http
HTTP/1.1 200 OK
Content-Type: application/json
```
```json
{
  "authorization_endpoint": "https://authorization-server.example.com/authorize",
  "code_challenge_methods_supported": [
    "plain",
    "S256"
  ],
  "grant_types_supported": [
    "authorization_code",
    "implicit",
    "refresh_token",
    "password",
    "client_credentials"
  ],
  "issuer": "https://authorization-server.example.com",
  "jwks_uri": "https://authorization-server.example.com/jwks",
  "registration_endpoint": "https://authorization-server.example.com/register",
  "request_object_signing_alg_values_supported": [
    "PS384",
    "ES384",
    "RS384",
    "HS256",
    "HS512",
    "ES256",
    "RS256",
    "HS384",
    "ES512",
    "PS256",
    "PS512",
    "RS512",
    "none"
  ],
  "response_types_supported": [
    "code",
    "none",
    "token",
    "code token"
  ],
  "scopes_supported": [
    "channelmapping",
    "connection",
    "events",
    "node",
    "query",
    "registration"
  ],
  "token_endpoint": "https://authorization-server.example.com/token",
  "token_endpoint_auth_methods_supported": [
    "private_key_jwt",
    "client_secret_basic",
    "client_secret_post",
    "tls_client_auth",
    "client_secret_jwt"
  ],
  "token_endpoint_auth_signing_alg_values_supported": [
    "PS384",
    "ES384",
    "RS384",
    "HS256",
    "HS512",
    "ES256",
    "RS256",
    "HS384",
    "ES512",
    "PS256",
    "PS512",
    "RS512"
  ]
}
```
## Client Registration 
NMOS nodes first needs to register with the Authorization Server.  This is usually a one time operation that a Node would typically perform when first activated on the network.

The registration is done via a [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration) with the Authorization Server. The registration includes the expected grant type, which should be set to  [client credentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials)

Depending on how the Authorization Server has been configured, it is likely that the Client Registration will need to be authenticated using an Initial Access Token.  This token will be generated by the Authentication Server, and provided to the NMOS Node by some proprietary method. 

Example client registration request including an Initial Access Token (This is the `Authorization: Bearer` in the HTTP header):

```
POST /register HTTP/1.1
Host: authorization-server.example.com
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCIg...
```
```json
{
  "client_name": "My Example Node",
  "grant_types": [
    "client_credentials"
  ],
  "jwks_uri": "https://node.example.com/jwks",
  "response_types": [
    "none"
  ],
  "scope": "registration",
  "token_endpoint_auth_method": "private_key_jwt"
}
```
Example response:
```http
HTTP/1.1 201 Created
Content-Type: application/json
```
```json    	
{
  "client_id": "30baf617-1744-4c24-9baf-22351bec1a73",
  "client_name": "My Example Node",
  "client_id_issued_at": 1611940142,
  "grant_types": [
    "client_credentials"
  ],
  "jwks_uri": "https://node.example.com/jwks",
  "response_types": [
  ],
  "token_endpoint_auth_method": "private_key_jwt"
}
```
## Client Credentials Flow
The Node can now request a bearer token from the Authorization Server using the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response). This access token will allow the Node to authenticate API calls on other NMOS Nodes, for instance, the NMOS Registry.

Example request to get bearer token:

```http
POST /token HTTP/1.1
Host: authorization-server.example.com
Content-Type: application/x-www-form-urlencoded
```
```
grant_type=client_credentials
&client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
&client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVC...
&client_id=30baf617-1744-4c24-9baf-22351bec1a73
&scope=registration
```

In this request the `client_assertion` is a self signed JWT and `client_id` is the result from client registration.

Example token response:
```http
HTTP/1.1 200 OK
Content-Type: application/json
```
```json
{
  "access_token": "eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...",
  "expires_in": 180,
  "scope": "registration",
  "token_type": "bearer"
}
```
## Refreshing the Bearer Token
The Bearer Token has a limited life specified in seconds by the value of the `expires_in` parameter.  The Node should refresh the token before [it exceeds its half life](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime) (if the token lifetime is 30 seconds, then it should be refreshed at least 15 seconds before token expiry). 

Unlike the Authorization Code Flow, the Client Credential Flow does not issue a refresh token 'refreshing' the token simply involves repeating the Client Credential Flow.

## Fetch Authorization Server Public Keys
As well as acquiring a token to allow this Node to register, the Node will also need the [Authorization Server's public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) so that it can authenticate calls on its own APIs.  These keys should be fetched every hour to ensure the keys are always up to date.

Example request to get server public keys:
```http
GET /jwks HTTP/1.1
Host: authorization-server.example.com
```
Example server public keys response:
```http
HTTP/1.1 200 OK
Content-Type: application/json
```
```json
[
  {
    "alg": "RS512",
    "e": "AQAB",
    "kid": "O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
    "kty": "RSA",
    "n": "yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkm...",
    "use": "sig",
    "x5c": [
      "MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQ..."
    ],
    "x5t": "LD3awp-sYoVbcfwOgB9BRO4HFYQ",
    "x5t#S256": "yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
  }
]
```
Note that if a Node is unable to contact an Authorization Server, it should attempt to contact another Authorization Server from the discovered list until this [either succeeds or the list is exhausted](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys). 
